# Jotai ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®

## ğŸ“ ç¢ºç«‹ã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
states/
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ sidebar/                    # ã‚µã‚¤ãƒ‰ãƒãƒ¼çŠ¶æ…‹ âœ…
â”‚   â”œâ”€â”€ editor/                     # ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼çŠ¶æ…‹ âœ…
â”‚   â”œâ”€â”€ device.ts                   # ãƒ‡ãƒã‚¤ã‚¹çŠ¶æ…‹ âœ…
â”‚   â”œâ”€â”€ page.ts                     # ãƒšãƒ¼ã‚¸UIçŠ¶æ…‹ âœ…
â”‚   â”œâ”€â”€ toc.ts                      # TOCçŠ¶æ…‹ âœ…
â”‚   â”œâ”€â”€ untitled-page.ts            # ç„¡é¡Œãƒšãƒ¼ã‚¸çŠ¶æ…‹ âœ…
â”‚   â”œâ”€â”€ page-abilities.ts           # ãƒšãƒ¼ã‚¸æ¨©é™åˆ¤å®šçŠ¶æ…‹ âœ… DERIVED ATOM!
â”‚   â”œâ”€â”€ unsaved-warning.ts          # æœªä¿å­˜è­¦å‘ŠçŠ¶æ…‹ âœ… JOTAI PATTERN!
â”‚   â””â”€â”€ modal/                      # å€‹åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚¡ã‚¤ãƒ« âœ…
â”‚       â”œâ”€â”€ page-create.ts          # ãƒšãƒ¼ã‚¸ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ page-delete.ts          # ãƒšãƒ¼ã‚¸å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ empty-trash.ts          # ã‚´ãƒŸç®±ç©ºãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ delete-attachment.ts    # æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ âœ…
â”‚       â”œâ”€â”€ delete-bookmark-folder.ts # ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤ âœ…
â”‚       â”œâ”€â”€ update-user-group-confirm.ts # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—æ›´æ–°ç¢ºèª âœ…
â”‚       â”œâ”€â”€ page-select.ts          # ãƒšãƒ¼ã‚¸é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ page-presentation.ts    # ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ put-back-page.ts        # ãƒšãƒ¼ã‚¸å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ granted-groups-inheritance-select.ts # æ¨©é™ã‚°ãƒ«ãƒ¼ãƒ—ç¶™æ‰¿é¸æŠ âœ…
â”‚       â”œâ”€â”€ drawio.ts               # Draw.ioãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ handsontable.ts         # Handsontableãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ private-legacy-pages-migration.ts # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¬ã‚¬ã‚·ãƒ¼ãƒšãƒ¼ã‚¸ç§»è¡Œ âœ…
â”‚       â”œâ”€â”€ descendants-page-list.ts # å­å­«ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆ âœ…
â”‚       â”œâ”€â”€ conflict-diff.ts        # ç«¶åˆå·®åˆ†ãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â”œâ”€â”€ page-bulk-export-select.ts # ãƒšãƒ¼ã‚¸ä¸€æ‹¬ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé¸æŠ âœ…
â”‚       â”œâ”€â”€ drawio-for-editor.ts    # ã‚¨ãƒ‡ã‚£ã‚¿ç”¨Draw.io âœ…
â”‚       â”œâ”€â”€ link-edit.ts            # ãƒªãƒ³ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”‚       â””â”€â”€ template.ts             # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« âœ…
â”œâ”€â”€ page/                           # ãƒšãƒ¼ã‚¸é–¢é€£çŠ¶æ…‹ âœ…
â”œâ”€â”€ server-configurations/          # ã‚µãƒ¼ãƒãƒ¼è¨­å®šçŠ¶æ…‹ âœ…
â”œâ”€â”€ global/                         # ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ âœ…
â”œâ”€â”€ socket-io/                      # Socket.IOçŠ¶æ…‹ âœ…
â”œâ”€â”€ context.ts                      # å…±é€šã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ âœ…
â””â”€â”€ features/
    â””â”€â”€ openai/
        â””â”€â”€ client/
            â””â”€â”€ states/             # OpenAIå°‚ç”¨çŠ¶æ…‹ âœ…
                â”œâ”€â”€ index.ts        # exports âœ…
                â””â”€â”€ unified-merge-view.ts # UnifiedMergeViewçŠ¶æ…‹ âœ…

features/                           # Feature Directory Pattern âœ…
â””â”€â”€ page-tree/                      # ãƒšãƒ¼ã‚¸ãƒ„ãƒªãƒ¼æ©Ÿèƒ½ âœ… (NEW!)
    â”œâ”€â”€ index.ts                    # ãƒ¡ã‚¤ãƒ³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    â”œâ”€â”€ client/
    â”‚   â”œâ”€â”€ components/             # æ±ç”¨UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    â”‚   â”‚   â”œâ”€â”€ SimplifiedItemsTree.tsx
    â”‚   â”‚   â”œâ”€â”€ TreeItemLayout.tsx
    â”‚   â”‚   â””â”€â”€ SimpleItemContent.tsx
    â”‚   â”œâ”€â”€ hooks/                  # æ±ç”¨ãƒ•ãƒƒã‚¯
    â”‚   â”‚   â”œâ”€â”€ use-data-loader.ts
    â”‚   â”‚   â””â”€â”€ use-scroll-to-selected-item.ts
    â”‚   â”œâ”€â”€ interfaces/             # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
    â”‚   â”‚   â””â”€â”€ index.ts            # TreeItemProps, TreeItemToolProps
    â”‚   â””â”€â”€ states/                 # JotaiçŠ¶æ…‹ âœ…
    â”‚       â”œâ”€â”€ page-tree-update.ts # ãƒ„ãƒªãƒ¼æ›´æ–°çŠ¶æ…‹
    â”‚       â””â”€â”€ page-tree-desc-count-map.ts # å­å­«ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹
    â””â”€â”€ constants/
        â””â”€â”€ index.ts                # ROOT_PAGE_VIRTUAL_ID
```

## ğŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®ãƒ«ãƒ¼ãƒ«

### UIçŠ¶æ…‹ç³» (`states/ui/`)
- **å€‹åˆ¥æ©Ÿèƒ½ãƒ•ã‚¡ã‚¤ãƒ«**: ãƒ‡ãƒã‚¤ã‚¹ã€TOCã€ç„¡é¡Œãƒšãƒ¼ã‚¸ç­‰ã®å˜ä¸€æ©Ÿèƒ½
- **è¤‡åˆæ©Ÿèƒ½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ç­‰ã®è¤‡æ•°æ©Ÿèƒ½
- **ãƒ¢ãƒ¼ãƒ€ãƒ«å°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: `modal/` é…ä¸‹ã«å€‹åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«

### ãƒ‡ãƒ¼ã‚¿é–¢é€£çŠ¶æ…‹ (`states/`)
- **ãƒšãƒ¼ã‚¸é–¢é€£**: `page/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- **ã‚µãƒ¼ãƒãƒ¼è¨­å®š**: `server-configurations/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- **ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹**: `global/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- **é€šä¿¡ç³»**: `socket-io/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

### æ©Ÿèƒ½åˆ¥å°‚ç”¨states (`states/features/` ãŠã‚ˆã³ `features/`)

**OpenAIæ©Ÿèƒ½**: `states/features/openai/client/states/`
**ãƒšãƒ¼ã‚¸ãƒ„ãƒªãƒ¼æ©Ÿèƒ½**: `features/page-tree/client/states/` âœ… (Feature Directory Pattern)

### Feature Directory Pattern (æ–°ãƒ‘ã‚¿ãƒ¼ãƒ³) âœ…

`features/{feature-name}/` ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ç‰¹å®šæ©Ÿèƒ½ã«é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ãƒ•ãƒƒã‚¯ã€çŠ¶æ…‹ã€å®šæ•°ã‚’ã™ã¹ã¦ä¸€ç®‡æ‰€ã«é›†ç´„ã™ã‚‹æ§‹é€ ã€‚

**é©ç”¨ä¾‹**: `features/page-tree/`
```
features/page-tree/
â”œâ”€â”€ index.ts           # å…¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®é›†ç´„
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ components/    # UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ hooks/         # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”œâ”€â”€ interfaces/    # å‹å®šç¾©
â”‚   â””â”€â”€ states/        # JotaiçŠ¶æ…‹
â””â”€â”€ constants/         # å®šæ•°
```

**ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–¹æ³•**:
```typescript
import { 
  SimplifiedItemsTree,
  TreeItemLayout,
  usePageTreeInformationUpdate,
  ROOT_PAGE_VIRTUAL_ID 
} from '~/features/page-tree';
```

## ğŸ·ï¸ ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

### çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«
- **å˜ä¸€æ©Ÿèƒ½**: `{æ©Ÿèƒ½å}.ts` ï¼ˆä¾‹: `device.ts`, `toc.ts`ï¼‰
- **è¤‡åˆæ©Ÿèƒ½**: `{æ©Ÿèƒ½å}/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä¾‹: `sidebar/`, `editor/`ï¼‰
- **ãƒ¢ãƒ¼ãƒ€ãƒ«**: `modal/{ãƒ¢ãƒ¼ãƒ€ãƒ«å}.ts`ï¼ˆä¾‹: `modal/page-create.ts`ï¼‰

### export/importè¦å‰‡
- **å…¬é–‹API**: `index.ts` ã§ã®re-export
- **å†…éƒ¨atom**: `_atomsForDerivedAbilities` ç‰¹æ®Šåexport
- **æ©Ÿèƒ½å°‚ç”¨**: æ©Ÿèƒ½ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ç‹¬ç«‹ã—ãŸstates

## ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ»è¤‡é›‘åº¦ã®ç›®å®‰

### é©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²
- **å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«**: ~100è¡Œä»¥å†…ã€å˜ä¸€è²¬å‹™
- **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ†å‰²**: è¤‡æ•°ã®hookãƒ»æ©Ÿèƒ½ãŒã‚ã‚‹å ´åˆ
- **å€‹åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«**: 1ãƒ¢ãƒ¼ãƒ€ãƒ« = 1ãƒ•ã‚¡ã‚¤ãƒ«åŸå‰‡

### è¤‡é›‘åº¦ã«ã‚ˆã‚‹åˆ†é¡
- **ã‚·ãƒ³ãƒ—ãƒ«**: BooleançŠ¶æ…‹ã€åŸºæœ¬çš„ãªå€¤ç®¡ç†
- **ä¸­ç¨‹åº¦**: è¤‡æ•°ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€actionsåˆ†é›¢
- **è¤‡é›‘**: Derived Atomã€Mapæ“ä½œã€å‰¯ä½œç”¨çµ±åˆ

## ğŸ”— ä¾å­˜é–¢ä¿‚ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ§‹é€ 

### ã‚¤ãƒ³ãƒãƒ¼ãƒˆéšå±¤
```
components/
â”œâ”€â”€ import from states/ui/          # UIçŠ¶æ…‹
â”œâ”€â”€ import from states/page/        # ãƒšãƒ¼ã‚¸çŠ¶æ…‹  
â”œâ”€â”€ import from states/global/      # ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
â””â”€â”€ import from states/features/    # æ©Ÿèƒ½åˆ¥çŠ¶æ…‹

states/ui/
â”œâ”€â”€ å†…éƒ¨ç›¸äº’å‚ç…§å¯èƒ½
â””â”€â”€ states/page/, states/global/ ã‹ã‚‰ã®import

states/features/{feature}/
â”œâ”€â”€ states/ui/ ã‹ã‚‰ã®import
â”œâ”€â”€ ä»–ã®features ã‹ã‚‰ã®importç¦æ­¢
â””â”€â”€ ç‹¬ç«‹æ€§ã‚’ä¿ã¤
```

### ç‰¹æ®ŠåExportä½¿ç”¨ç®‡æ‰€
```
states/page/internal-atoms.ts â†’ _atomsForDerivedAbilities
states/ui/editor/atoms.ts â†’ _atomsForDerivedAbilities  
states/global/global.ts â†’ _atomsForDerivedAbilities
states/context.ts â†’ _atomsForDerivedAbilities
```

## ğŸ¯ ä»Šå¾Œã®æ‹¡å¼µæŒ‡é‡

### æ–°è¦æ©Ÿèƒ½è¿½åŠ æ™‚
1. **æ©Ÿèƒ½å°‚ç”¨åº¦è©•ä¾¡**: æ±ç”¨ â†’ `states/ui/`ã€å°‚ç”¨ â†’ `features/{feature-name}/client/states/`
2. **è¤‡é›‘åº¦è©•ä¾¡**: ã‚·ãƒ³ãƒ—ãƒ« â†’ å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã€è¤‡é›‘ â†’ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
3. **ä¾å­˜é–¢ä¿‚ç¢ºèª**: æ—¢å­˜atomã®æ´»ç”¨å¯èƒ½æ€§
4. **å‘½åè¦å‰‡éµå®ˆ**: ç¢ºç«‹ã•ã‚ŒãŸå‘½åãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã†
5. **Feature Directory Patternæ¤œè¨**: è¤‡æ•°ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ»ãƒ•ãƒƒã‚¯ãƒ»çŠ¶æ…‹ãŒé–¢é€£ã™ã‚‹å ´åˆã¯ `features/` é…ä¸‹ã«é›†ç´„

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ç¶­æŒ
- **è²¬å‹™å˜ä¸€åŸå‰‡**: 1ãƒ•ã‚¡ã‚¤ãƒ« = 1æ©Ÿèƒ½ãƒ»è²¬å‹™
- **ä¾å­˜é–¢ä¿‚æœ€å°åŒ–**: å¾ªç’°å‚ç…§ã®å›é¿
- **æ‹¡å¼µæ€§**: å°†æ¥ã®æ©Ÿèƒ½è¿½åŠ ã‚’è€ƒæ…®ã—ãŸæ§‹é€ 
- **æ¤œç´¢æ€§**: ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æ©Ÿèƒ½ãŒæ¨æ¸¬ã§ãã‚‹å‘½å

### Feature Directory Pattern æ¡ç”¨åŸºæº–
ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã™å ´åˆã¯ `features/` é…ä¸‹ã«é…ç½®:
- è¤‡æ•°ã®UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒé–¢é€£ã—ã¦ã„ã‚‹
- å°‚ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ãŒã‚ã‚‹
- å°‚ç”¨ã®JotaiçŠ¶æ…‹ãŒã‚ã‚‹
- æ©Ÿèƒ½ã¨ã—ã¦ç‹¬ç«‹æ€§ãŒé«˜ã„

**ä¾‹**: `features/page-tree/` ã¯ SimplifiedItemsTree, TreeItemLayout, useDataLoader, page-tree-update.ts ãªã©ãŒå¯†æ¥ã«é–¢é€£

---

## ğŸ“ æœ€çµ‚æ›´æ–°æ—¥

2025-11-28 (Feature Directory Pattern è¿½åŠ )