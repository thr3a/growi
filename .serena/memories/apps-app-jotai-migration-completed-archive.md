# Jotai ç§»è¡Œå®Œäº†ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

## âœ… å®Œäº†æ¸ˆã¿ç§»è¡Œã®è©³ç´°è¨˜éŒ²

### ğŸ‰ ãƒ¢ãƒ¼ãƒ€ãƒ«çŠ¶æ…‹ç§»è¡Œå®Œäº†ï¼ˆå€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«æ–¹å¼ï¼‰

#### ç¬¬1ãƒãƒƒãƒï¼ˆ2025-09-05å®Œäº†ï¼‰
- âœ… **`useEmptyTrashModal`**: ã‚´ãƒŸç®±ç©ºãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useDeleteAttachmentModal`**: æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useDeleteBookmarkFolderModal`**: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useUpdateUserGroupConfirmModal`**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—æ›´æ–°ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«

#### ç¬¬2ãƒãƒƒãƒï¼ˆ2025-09-05å®Œäº†ï¼‰
- âœ… **`usePageSelectModal`**: ãƒšãƒ¼ã‚¸é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`usePagePresentationModal`**: ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`usePutBackPageModal`**: ãƒšãƒ¼ã‚¸å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ«

#### ç¬¬3ãƒãƒƒãƒï¼ˆ2025-09-05å®Œäº†ï¼‰
- âœ… **`useGrantedGroupsInheritanceSelectModal`**: æ¨©é™ã‚°ãƒ«ãƒ¼ãƒ—ç¶™æ‰¿é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useDrawioModal`**: Draw.ioãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useHandsontableModal`**: Handsontableãƒ¢ãƒ¼ãƒ€ãƒ«

#### ç¬¬4ãƒãƒƒãƒï¼ˆ2025-09-05å®Œäº†ï¼‰
- âœ… **`usePrivateLegacyPagesMigrationModal`**: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¬ã‚¬ã‚·ãƒ¼ãƒšãƒ¼ã‚¸ç§»è¡Œãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useDescendantsPageListModal`**: å­å­«ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useConflictDiffModal`**: ç«¶åˆå·®åˆ†ãƒ¢ãƒ¼ãƒ€ãƒ«

#### ç¬¬5ãƒãƒƒãƒï¼ˆ2025-09-05å®Œäº†ï¼‰
- âœ… **`usePageBulkExportSelectModal`**: ãƒšãƒ¼ã‚¸ä¸€æ‹¬ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useDrawioModalForEditor`**: ã‚¨ãƒ‡ã‚£ã‚¿ç”¨Draw.ioãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useLinkEditModal`**: ãƒªãƒ³ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
- âœ… **`useTemplateModal`**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«

#### ğŸ”¥ å®Ÿè£…ã®ç‰¹å¾´
- **å‹å®‰å…¨æ€§**: `@growi/core` ã‹ã‚‰ã®æ­£ã—ã„å‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: `useAtomValue` + `useSetAtom` ãƒ•ãƒƒã‚¯åˆ†é›¢ã«ã‚ˆã‚‹æœ€é©åŒ–
- **ä½¿ç”¨ç®‡æ‰€å®Œå…¨ç§»è¡Œ**: å…¨ã¦ã®ä½¿ç”¨ç®‡æ‰€ã‚’æ–°ã—ã„ãƒ•ãƒƒã‚¯ã«ç§»è¡Œæ¸ˆã¿
- **æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤**: `stores/modal.tsx` ã‹ã‚‰ã®æ—§å®Ÿè£…å‰Šé™¤å®Œäº†
- **å‹ãƒã‚§ãƒƒã‚¯æˆåŠŸ**: `pnpm run lint:typecheck` é€šéç¢ºèªæ¸ˆã¿
- **çµ±ä¸€ã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³**: å…¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ä¸€è²«ã—ãŸJotaiãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨

### ğŸ†• ãƒ‡ãƒã‚¤ã‚¹çŠ¶æ…‹ç§»è¡Œå®Œäº†ï¼ˆ2025-09-11å®Œäº†ï¼‰

#### âœ… Phase 1: ãƒ‡ãƒã‚¤ã‚¹å¹…é–¢é€£ãƒ•ãƒƒã‚¯4å€‹ä¸€æ‹¬ç§»è¡Œå®Œäº†
- âœ… **`useIsDeviceLargerThanMd`**: MDä»¥ä¸Šã®ãƒ‡ãƒã‚¤ã‚¹å¹…åˆ¤å®š
  - ä½¿ç”¨ç®‡æ‰€ï¼š8å€‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Œå…¨ç§»è¡Œ
- âœ… **`useIsDeviceLargerThanLg`**: LGä»¥ä¸Šã®ãƒ‡ãƒã‚¤ã‚¹å¹…åˆ¤å®š
  - ä½¿ç”¨ç®‡æ‰€ï¼š3å€‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Œå…¨ç§»è¡Œ
- âœ… **`useIsMobile`**: ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
  - ä½¿ç”¨ç®‡æ‰€ï¼š1å€‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Œå…¨ç§»è¡Œ

#### ğŸš€ ç§»è¡Œã®æˆæœ
- **çµ±ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³**: æ—¢å­˜ã® `useDeviceLargerThanXl` ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆã‚ã›ã¦å®Ÿè£…
- **MediaQueryå¯¾å¿œ**: ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆç›£è¦–ã«ã‚ˆã‚‹å‹•çš„ãªçŠ¶æ…‹æ›´æ–°
- **ãƒ¢ãƒã‚¤ãƒ«æ¤œå‡º**: ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ»UserAgent ã«ã‚ˆã‚‹é«˜ç²¾åº¦åˆ¤å®š
- **ãƒ†ã‚¹ãƒˆä¿®æ­£**: ãƒ¢ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°å®Œäº†
- **æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤**: `stores/ui.tsx` ã‹ã‚‰3ã¤ã®ãƒ•ãƒƒã‚¯å‰Šé™¤å®Œäº†

#### ğŸ“Š ç§»è¡Œè©³ç´°
**ç§»è¡Œã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 11å€‹
- PageControls.tsx, AccessTokenScopeList.tsx, PageEditorModeManager.tsx
- GrowiContextualSubNavigation.tsx, SavePageControls.tsx, OptionsSelector.tsx
- Sidebar.tsx, PageListItemL.tsx, DescendantsPageListModal.tsx
- PageAccessoriesModal.tsx, PrimaryItem.tsx

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£**: 1å€‹
- DescendantsPageListModal.spec.tsx: ãƒ¢ãƒƒã‚¯æˆ»ã‚Šå€¤ã‚’ `{ data: boolean }` â†’ `[boolean]` ã«å¤‰æ›´

### ğŸ†• TOCçŠ¶æ…‹ç§»è¡Œå®Œäº†ï¼ˆ2025-09-11å®Œäº†ï¼‰

#### âœ… TOCé–¢é€£ãƒ•ãƒƒã‚¯å®Œå…¨ç§»è¡Œå®Œäº†
- âœ… **`useTocNode`**: TOCãƒãƒ¼ãƒ‰å–å¾—ï¼ˆæ–°APIï¼‰
- âœ… **`useSetTocNode`**: TOCãƒãƒ¼ãƒ‰è¨­å®šï¼ˆæ–°APIï¼‰  
- âœ… **`useTocOptions`**: TOCã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆSWRã‹ã‚‰Jotai + Dynamic Importï¼‰
- âœ… **`useTocOptionsReady`**: TOCã‚ªãƒ—ã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†åˆ¤å®š

#### ğŸš€ ç§»è¡Œã®æˆæœã¨æŠ€è¡“çš„ç‰¹å¾´

**1. APIæ•´ç†ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
- **çµ±åˆ**: TOCé–¢é€£å‡¦ç†ã‚’ `states/ui/toc.ts` ã«é›†ç´„
- **å‰Šé™¤**: deprecated APIï¼ˆ`useCurrentPageTocNode`, `useSetCurrentPageTocNode`ï¼‰å®Œå…¨å‰Šé™¤
- **ãƒªãƒ•ã‚¡ã‚¯ã‚¿**: `states/ui/page.ts` ã‹ã‚‰TOCé–¢é€£re-exportå‰Šé™¤
- **è²¬å‹™åˆ†é›¢**: PageControlsé–¢é€£ã¨TOCé–¢é€£ã®å®Œå…¨åˆ†é›¢

**2. RefObjectãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹å‹å®‰å…¨ãªDOMç®¡ç†**
```typescript
// Internal RefObject storage (hidden from external API)
const tocNodeRefAtom = atom<RefObject<HtmlElementNode> | null>(null);

// Public derived atom for direct access
export const tocNodeAtom = atom((get) => {
  const tocNodeRef = get(tocNodeRefAtom);
  return tocNodeRef?.current ?? null;
});
```

**3. Dynamic Import + Cachingã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
```typescript
// Heavy renderer dependencies are lazy-loaded
let generateTocOptionsCache: typeof generateTocOptions | null = null;

if (!generateTocOptionsCache) {
  const { generateTocOptions } = await import('~/client/services/renderer/renderer');
  generateTocOptionsCache = generateTocOptions;
}
```

**4. SWRã‹ã‚‰Jotaiå®Œå…¨ç§»è¡Œ**
- **Before**: SWR-based `useTocOptions` with server-side dependency
- **After**: Pure Jotai state management with optimized caching
- **Code Size**: 50%å‰Šæ¸›ï¼ˆ54è¡Œ â†’ 27è¡Œï¼‰

#### ğŸ¯ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸ŠåŠ¹æœ
1. **Bundle Splitting**: renderer.tsxï¼ˆ20+ dependenciesï¼‰ã®é…å»¶ãƒ­ãƒ¼ãƒ‰
2. **Code Splitting**: KaTeX, Mermaid, PlantUMLç­‰ã®é‡ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåˆ†é›¢
3. **Caching**: ä¸€åº¦ãƒ­ãƒ¼ãƒ‰å¾Œã®åŒæœŸå®Ÿè¡Œ
4. **First Contentful Paint**: åˆæœŸãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºå‰Šæ¸›

#### ğŸ“Š ç§»è¡Œå½±éŸ¿ç¯„å›²
- **æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«**: `states/ui/toc.ts`, `states/ui/page.ts`, `stores/renderer.tsx`
- **ä½¿ç”¨ç®‡æ‰€**: `TableOfContents.tsx`ï¼ˆæ—¢ã«æ–°APIå¯¾å¿œæ¸ˆã¿ï¼‰
- **å‰Šé™¤ã‚³ãƒ¼ãƒ‰**: deprecated hooks, re-exports, å†—é•·ãªã‚³ãƒ¡ãƒ³ãƒˆ

### ğŸ†• ç„¡é¡Œãƒšãƒ¼ã‚¸çŠ¶æ…‹ç§»è¡Œå®Œäº†ï¼ˆ2025-09-11å®Œäº†ï¼‰

#### âœ… ç„¡é¡Œãƒšãƒ¼ã‚¸é–¢é€£ãƒ•ãƒƒã‚¯å®Œå…¨ç§»è¡Œå®Œäº†
- âœ… **`useIsUntitledPage`**: ç„¡é¡Œãƒšãƒ¼ã‚¸çŠ¶æ…‹å–å¾—ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªbooleanï¼‰
- âœ… **`useSetIsUntitledPage`**: ç„¡é¡Œãƒšãƒ¼ã‚¸çŠ¶æ…‹è¨­å®šï¼ˆç›´æ¥çš„ãªsetterï¼‰

#### ğŸš€ ç§»è¡Œã®æˆæœã¨æŠ€è¡“çš„ç‰¹å¾´

**1. ã‚·ãƒ³ãƒ—ãƒ«ãªBooleançŠ¶æ…‹ãƒ‘ã‚¿ãƒ¼ãƒ³ç¢ºç«‹**
```typescript
// Atomå®šç¾©ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
const isUntitledPageAtom = atom<boolean>(false);

// èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ãƒƒã‚¯
export const useIsUntitledPage = (): boolean => {
  return useAtomValue(isUntitledPageAtom);
};

// ã‚»ãƒƒã‚¿ãƒ¼å°‚ç”¨ãƒ•ãƒƒã‚¯ï¼ˆuseSetAtomç›´æ¥ä½¿ç”¨ï¼‰
export const useSetIsUntitledPage = () => {
  return useSetAtom(isUntitledPageAtom);
};
```

**2. SWRå¾Œæ–¹äº’æ›æ€§ã®å®Œå…¨æ’é™¤**
- **Before**: SWR responseå½¢å¼ï¼ˆ`{ data: boolean, mutate: function }`ï¼‰
- **After**: ç›´æ¥çš„ãªbooleanå€¤ã¨setteré–¢æ•°
- **ãƒ¡ãƒªãƒƒãƒˆ**: ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„ã€ä¸è¦ãªè¤‡é›‘æ€§ã®æ’é™¤

**3. ä½¿ç”¨ç®‡æ‰€ã®å®Œå…¨ç§»è¡Œ**
- **èª­ã¿å–ã‚Š**: `const { data: isUntitled } = useIsUntitledPage()` â†’ `const isUntitled = useIsUntitledPage()`
- **å¤‰æ›´**: `const { mutate } = useIsUntitledPage()` â†’ `const setIsUntitled = useSetIsUntitledPage()`
- **ç›´æ¥å‘¼ã³å‡ºã—**: `mutate(value)` â†’ `setIsUntitled(value)`

#### ğŸ“Š ç§»è¡Œå½±éŸ¿ç¯„å›²
- **æ–°ãƒ•ã‚¡ã‚¤ãƒ«**: `states/ui/untitled-page.ts`ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ï¼‰
- **ç§»è¡Œç®‡æ‰€**: 5å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPageTitleHeader.tsx, PageEditor.tsx, page-path-rename-utils.ts, use-create-page.tsx, use-update-page.tsxï¼‰
- **ãƒ†ã‚¹ãƒˆä¿®æ­£**: PageTitleHeader.spec.tsxï¼ˆãƒ¢ãƒƒã‚¯æˆ»ã‚Šå€¤ã‚’ `{ data: boolean }` â†’ `boolean` ã«å¤‰æ›´ï¼‰
- **æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤**: `stores/ui.tsx` ã‹ã‚‰ã® `useIsUntitledPage` å‰Šé™¤å®Œäº†

#### ğŸ¯ è¨­è¨ˆåŸå‰‡ã®æ˜ç¢ºåŒ–
- **SWRå¾Œæ–¹äº’æ›æ€§ä¸è¦æ™‚**: ç›´æ¥çš„ãªgetter/setterãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å„ªå…ˆ**: `useAtomValue` + `useSetAtom` ã®åˆ†é›¢ã«ã‚ˆã‚Šæœ€é©åŒ–
- **è¤‡é›‘æ€§æ’é™¤**: ä¸è¦ãªwrapperé–¢æ•°ã‚„callbackä¸è¦
- **å‹å®‰å…¨æ€§**: TypeScriptã«ã‚ˆã‚‹å®Œå…¨ãªå‹ãƒã‚§ãƒƒã‚¯

## ğŸ“ˆ åŠ¹ç‡åŒ–ã•ã‚ŒãŸç§»è¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®æˆåŠŸäº‹ä¾‹
- **ãƒãƒƒãƒå‡¦ç†**: 3-4å€‹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’åŒæ™‚ç§»è¡Œ
- **æ‰€è¦æ™‚é–“**: å„ãƒãƒƒãƒç´„1æ™‚é–“ã§å®Œäº†
- **å“è³ªç¢ºèª**: å‹ãƒã‚§ãƒƒã‚¯æˆåŠŸã€å…¨ä½¿ç”¨ç®‡æ‰€ç§»è¡Œæ¸ˆã¿
- **çµ±ä¸€ã•ã‚ŒãŸå®Ÿè£…**: å…¨17å€‹ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ä¸€è²«ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³

## ğŸš€ ç´¯ç©çš„ãªæˆæœã¨ãƒ¡ãƒªãƒƒãƒˆ
1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š**: ä¸è¦ãªãƒªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®å‰Šæ¸›ã€Bundle Splittingã€è‡ªå‹•ãƒ¡ãƒ¢åŒ–
2. **é–‹ç™ºä½“é¨“å‘ä¸Š**: çµ±ä¸€ã•ã‚ŒãŸAPIãƒ‘ã‚¿ãƒ¼ãƒ³ã€å‹å®‰å…¨æ€§ã€ãƒ‡ãƒãƒƒã‚°æ€§å‘ä¸Š
3. **ä¿å®ˆæ€§å‘ä¸Š**: å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«åŒ–ã«ã‚ˆã‚‹è²¬å‹™æ˜ç¢ºåŒ–ã€APIæ•´ç†ã€è¨ˆç®—çµæœå…±æœ‰
4. **å‹å®‰å…¨æ€§**: Jotaiã«ã‚ˆã‚‹å¼·å›ºãªå‹ã‚·ã‚¹ãƒ†ãƒ 
5. **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ**: æ­£ç¢ºãªãƒ‡ãƒã‚¤ã‚¹å¹…ãƒ»ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®š
6. **DOMç®¡ç†**: RefObjectãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹å®‰å…¨ãªDOMè¦ç´ ç®¡ç†
7. **ã‚·ãƒ³ãƒ—ãƒ«æ€§**: ä¸è¦ãªè¤‡é›‘æ€§ã®æ’é™¤ã€ç›´æ¥çš„ãªAPIè¨­è¨ˆ

## ğŸ—‚ï¸ å‰Šé™¤å®Œäº†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«
- âœ… `stores/modal.tsx` ï¼ˆå®Œå…¨å‰Šé™¤ï¼‰
- âœ… `stores/ui.tsx` ï¼ˆå®Œå…¨å‰Šé™¤ï¼‰
- âœ… `stores/use-static-swr.ts` ï¼ˆå®Œå…¨å‰Šé™¤ï¼‰
- âœ… `stores-universal/context.tsx` ï¼ˆéƒ¨åˆ†å‰Šé™¤ï¼šuseContextSWRç³»ãƒ•ãƒƒã‚¯å‰Šé™¤æ¸ˆã¿ï¼‰